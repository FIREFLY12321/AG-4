name: CI/CD Deployment Pipeline (Outstanding Level++)
permissions:
  contents: write
  pull-requests: write
  issues: write

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # ===============================
  # ğŸ—ï¸ Job 1ï¼šå»ºç½® + æ¸¬è©¦ + ä¸Šå‚³ artifact
  # ===============================
  build:
    name: Build and Test (Matrix)
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.NEW_TAG }}
      changelog: ${{ steps.changelog.outputs.CHANGELOG }}
    strategy:
      matrix:
        node: [18, 20]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}

      - name: Install Bun runtime
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Generate Semantic Version
        id: version
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          NEW_TAG=$(echo $LAST_TAG | awk -F. -v OFS=. '{$NF += 1 ; print}')
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ New Version: $NEW_TAG"

      # ğŸ§¾ è‡ªå‹•ç”¢ç”Ÿ Changelog
      - name: Generate Changelog
        id: changelog
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            CHANGELOG=$(git log --oneline --pretty=format:"- %s (%h)" | head -20)
          else
            CHANGELOG=$(git log ${LAST_TAG}..HEAD --oneline --pretty=format:"- %s (%h)")
          fi
          
          # å„²å­˜åˆ°æª”æ¡ˆé¿å…ç‰¹æ®Šå­—å…ƒå•é¡Œ
          echo "$CHANGELOG" > changelog.txt
          
          # ä½¿ç”¨ multiline output
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "ğŸ“ Changelog generated:"
          echo "$CHANGELOG"

      # ğŸ§ª Pre-build Lint Gate (Fail Fast)
      - name: Run Lint Check (Quality Gate)
        run: |
          echo "ğŸ” Running lint checks..."
          bun run lint || {
            echo "âŒ Lint check failed! Please fix code style issues."
            exit 1
          }

      - name: Install dependencies and build
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          bun install
          echo "ğŸ—ï¸ Building project..."
          bun run build
          zip -r build.zip .

      # ğŸ§ª Pre-build Test Gate
      - name: Run Tests (Quality Gate)
        run: |
          echo "ğŸ§ª Running tests..."
          bun run test || {
            echo "âŒ Tests failed! Build cannot proceed."
            exit 1
          }

      - name: Upload build artifact (unique per Node)
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact-${{ matrix.node }}
          path: build.zip
          retention-days: 1

      # ğŸ“§ Notify PR with Build Status
      - name: Comment on PR (Build Success)
        if: github.event_name == 'pull_request' && success()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âœ… **Build Successful** (Node ${{ matrix.node }})\n\n` +
                    `Version: \`${{ steps.version.outputs.NEW_TAG }}\`\n` +
                    `All tests passed and ready for deployment!`
            })

      - name: Comment on PR (Build Failed)
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `âŒ **Build Failed** (Node ${{ matrix.node }})\n\n` +
                    `Please check the workflow logs for details.`
            })

  # ===============================
  # ğŸš€ Job 2ï¼šéƒ¨ç½²è‡³ dev ç’°å¢ƒ
  # ===============================
  deploy-dev:
    name: Deploy to Development
    needs: build
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
          
      - name: Install GitHub CLI
        run: sudo apt install gh -y
          
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: build-artifact-*
          merge-multiple: true
            
      - name: Verify artifact
        run: ls -lh
  
      # ğŸ” ä½¿ç”¨ç’°å¢ƒå°ˆå±¬ Token
      - name: Create or Update Dev Release
        env:
          GITHUB_TOKEN: ${{ secrets.DEV_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          TAG="dev-${{ needs.build.outputs.version }}"
          
          # åŒ…å« Changelog çš„ç™¼å¸ƒèªªæ˜
          cat > release_notes.md << 'EOF'
          ## ğŸ”§ Development Build
          
          **Version:** ${{ needs.build.outputs.version }}
          **Environment:** Development
          
          ### ğŸ“ Changes in this release:
          ${{ needs.build.outputs.changelog }}
          
          ---
          *Auto-generated by GitHub Actions*
          EOF
          
          echo "ğŸš€ Deploying $TAG"
          if gh release view "$TAG" > /dev/null 2>&1; then
            echo "â™»ï¸ Updating existing dev release..."
            gh release upload "$TAG" build.zip --clobber
            gh release edit "$TAG" --notes-file release_notes.md
          else
            echo "ğŸ†• Creating new dev release..."
            gh release create "$TAG" build.zip --notes-file release_notes.md
          fi

      # ğŸ“§ é€šçŸ¥ç›¸é—œ Issue
      - name: Notify Related Issues
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # å¾æœ€è¿‘çš„ commit è¨Šæ¯ä¸­æå– issue ç·¨è™Ÿ
          ISSUES=$(git log -1 --pretty=%B | grep -oP '#\K\d+' || echo "")
          
          if [ ! -z "$ISSUES" ]; then
            for ISSUE in $ISSUES; do
              gh issue comment $ISSUE --body "ğŸš€ Related code has been deployed to **dev** environment (v${{ needs.build.outputs.version }})" || true
            done
          fi

      - name: Deployment Status
        if: always()
        run: echo "âœ… Dev deployment ${{ needs.build.outputs.version }} finished"

  # ===============================
  # ğŸ§ª Job 3ï¼šéƒ¨ç½²è‡³ staging ç’°å¢ƒ
  # ===============================
  deploy-staging:
    name: Deploy to Staging
    needs: [build, deploy-dev]
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
  
      - name: Install GitHub CLI
        run: sudo apt install gh -y
  
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: build-artifact-*
          merge-multiple: true
  
      # ğŸ” ä½¿ç”¨ Staging å°ˆå±¬ Token
      - name: Create or Update Staging Release
        env:
          GITHUB_TOKEN: ${{ secrets.STG_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          TAG="staging-${{ needs.build.outputs.version }}"
          
          cat > release_notes.md << 'EOF'
          ## ğŸ§ª Staging Build (Pre-Production)
          
          **Version:** ${{ needs.build.outputs.version }}
          **Environment:** Staging
          
          ### ğŸ“ Changes in this release:
          ${{ needs.build.outputs.changelog }}
          
          ### âš ï¸ Testing Required
          Please conduct thorough testing before promoting to production.
          
          ---
          *Auto-generated by GitHub Actions*
          EOF
          
          echo "ğŸš€ Deploying staging release: $TAG"
          if gh release view "$TAG" > /dev/null 2>&1; then
            echo "â™»ï¸ Updating existing staging release..."
            gh release upload "$TAG" build.zip --clobber
            gh release edit "$TAG" --notes-file release_notes.md
          else
            echo "ğŸ†• Creating new staging release..."
            gh release create "$TAG" build.zip --notes-file release_notes.md
          fi

      # ğŸ“§ Notify PR about Staging Deployment
      - name: Comment on PR (Staging Deployed)
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `ğŸ§ª **Deployed to Staging**\n\n` +
                    `Version: \`${{ needs.build.outputs.version }}\`\n` +
                    `Ready for QA testing before production release.`
            })

      - name: Slack Notification
        if: always()
        env:
          WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' \
            --data "{\"text\":\"ğŸ§© Staging release *${{ needs.build.outputs.version }}* completed successfully.\n\nğŸ“ Changelog:\n\`\`\`${{ needs.build.outputs.changelog }}\`\`\`\"}" \
            $WEBHOOK_URL || echo "âš ï¸ Slack not configured"

  # ===============================
  # ğŸ¯ Job 4ï¼šéƒ¨ç½²è‡³ production ç’°å¢ƒï¼ˆéœ€äººå·¥æ‰¹å‡†ï¼‰
  # ===============================
  deploy-production:
    name: Deploy to Production
    needs: [build, deploy-staging]
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: sudo apt install gh -y

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: build-artifact-*
          merge-multiple: true

      # ğŸ” ä½¿ç”¨ Production å°ˆå±¬ Token (æœ€é«˜æ¬Šé™)
      - name: Create Production Release
        env:
          GITHUB_TOKEN: ${{ secrets.PROD_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          TAG="prod-${{ needs.build.outputs.version }}"
          
          cat > release_notes.md << 'EOF'
          ## ğŸš€ Production Release
          
          **Version:** ${{ needs.build.outputs.version }}
          **Environment:** Production
          **Released:** $(date '+%Y-%m-%d %H:%M:%S UTC')
          
          ### ğŸ“ Changes in this release:
          ${{ needs.build.outputs.changelog }}
          
          ### âœ… Quality Gates Passed
          - âœ“ Lint checks
          - âœ“ Unit tests
          - âœ“ Dev deployment
          - âœ“ Staging verification
          - âœ“ Manual approval
          
          ---
          *Official production release - Auto-generated by GitHub Actions*
          EOF
          
          echo "ğŸš€ Creating production release: $TAG"
          if gh release view "$TAG" > /dev/null 2>&1; then
            echo "â™»ï¸ Updating existing production release..."
            gh release upload "$TAG" build.zip --clobber
            gh release edit "$TAG" --notes-file release_notes.md
          else
            echo "ğŸ†• Creating new production release..."
            gh release create "$TAG" build.zip --notes-file release_notes.md --latest
          fi

      # ğŸ“§ Notify All Related PRs and Issues
      - name: Notify Production Deployment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # é€šçŸ¥æœ€è¿‘åˆä½µçš„ PR
          RECENT_PR=$(gh pr list --state merged --limit 1 --json number --jq '.[0].number' || echo "")
          
          if [ ! -z "$RECENT_PR" ]; then
            gh pr comment $RECENT_PR --body "ğŸ‰ **Deployed to Production!**

Version: \`${{ needs.build.outputs.version }}\`

Your changes are now live in production! ğŸš€" || true
          fi
          
          # é€šçŸ¥ç›¸é—œ issues
          ISSUES=$(git log -5 --pretty=%B | grep -oP '#\K\d+' | sort -u || echo "")
          
          if [ ! -z "$ISSUES" ]; then
            for ISSUE in $ISSUES; do
              gh issue comment $ISSUE --body "ğŸ‰ **Deployed to Production!**

Version: \`${{ needs.build.outputs.version }}\`

Related changes are now live! Issue can be closed if resolved." || true
            done
          fi

      - name: Rollback on Failure
        if: failure()
        run: |
          echo "âš ï¸ Production deployment failed â€” rolling back..."
          gh release delete "prod-${{ needs.build.outputs.version }}" --yes || echo "No rollback needed"
          
          # é€šçŸ¥åœ˜éšŠéƒ¨ç½²å¤±æ•—
          curl -X POST -H 'Content-type: application/json' \
            --data '{"text":"ğŸš¨ *PRODUCTION DEPLOYMENT FAILED* ğŸš¨\n\nVersion: `${{ needs.build.outputs.version }}`\nAutomatic rollback initiated.\n\n@channel Please investigate immediately!"}' \
            ${{ secrets.SLACK_WEBHOOK_URL }} || echo "âš ï¸ Slack not configured