name: CI/CD Deployment Pipeline (Outstanding Level)
permissions:
  contents: write
  pull-requests: write
  issues: write

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # ===============================
  # ðŸ—ï¸ Job 1ï¼šå»ºç½® + æ¸¬è©¦ + ä¸Šå‚³ artifact
  # ===============================
  build:
    name: Build and Test (Matrix)
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.NEW_TAG }}
    strategy:
      matrix:
        node: [18, 20]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}

      - name: Install Bun runtime
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      # ðŸ“¦ è‡ªå‹•éžå¢žç‰ˆæœ¬è™Ÿ
      - name: Generate Semantic Version
        id: version
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          NEW_TAG=$(echo $LAST_TAG | awk -F. -v OFS=. '{$NF += 1 ; print}')
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ New Version: $NEW_TAG"

      # ðŸ§¾ ç”¢ç”Ÿ changelog
      - name: Generate Changelog
        if: matrix.node == 18
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            git log --oneline --pretty=format:"- %s (%h)" | head -20 > changelog.txt
          else
            git log ${LAST_TAG}..HEAD --oneline --pretty=format:"- %s (%h)" > changelog.txt
          fi
          echo "ðŸ“ changelog.txt generated"
      
      - name: Save changelog as artifact
        if: matrix.node == 18
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: changelog.txt

      # ðŸ§ª Quality Gateï¼šLint + Test
      - name: ðŸ” Pre-build Quality Gate
        run: |
          echo "ðŸ” Running quality checks..."
          set +e
          LINT_OUTPUT=$(bun run lint 2>&1)
          LINT_EXIT=$?
          TEST_OUTPUT=$(bun run test 2>&1)
          TEST_EXIT=$?
          set -e

          if echo "$LINT_OUTPUT" | grep -qi "was not found"; then
            echo "âš ï¸ No lint script - skipped"
          elif [ $LINT_EXIT -ne 0 ]; then
            echo "$LINT_OUTPUT"
            exit 1
          else
            echo "âœ… Lint passed"
          fi

          if echo "$TEST_OUTPUT" | grep -qi "was not found"; then
            echo "âš ï¸ No test script - skipped"
          elif [ $TEST_EXIT -ne 0 ]; then
            echo "$TEST_OUTPUT"
            exit 1
          else
            echo "âœ… Tests passed"
          fi

      - name: Install dependencies and build
        run: |
          echo "ðŸ“¦ Installing dependencies..."
          bun install
          echo "ðŸ—ï¸ Building project..."
          bun run build
          zip -r build.zip .

      - name: Upload build artifact (per Node)
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact-${{ matrix.node }}
          path: build.zip
          retention-days: 1

  # ===============================
  # ðŸš€ Job 2ï¼šéƒ¨ç½²è‡³ dev ç’°å¢ƒ
  # ===============================
  deploy-dev:
    name: Deploy to Development
    needs: build
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: sudo apt install gh -y

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          pattern: build-artifact-*
          merge-multiple: true

      - name: Download changelog
        uses: actions/download-artifact@v4
        with:
          name: changelog

      - name: Create or Update Dev Release
        env:
          GITHUB_TOKEN: ${{ secrets.DEV_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          TAG="dev-${{ needs.build.outputs.version }}"
          CHANGELOG=$(cat changelog.txt)
          NOTE="Development build $TAG

          ## ðŸ“ Changes:
          $CHANGELOG"
          echo "ðŸš€ Deploying Dev $TAG"

          if gh release view "$TAG" > /dev/null 2>&1; then
            gh release upload "$TAG" build.zip --clobber
            gh release edit "$TAG" --notes "$NOTE"
          else
            gh release create "$TAG" build.zip --notes "$NOTE"
          fi

  # ===============================
  # ðŸ§ª Job 3ï¼šéƒ¨ç½²è‡³ staging ç’°å¢ƒ
  # ===============================
  deploy-staging:
    name: Deploy to Staging
    needs: [build, deploy-dev]
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: sudo apt install gh -y

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          pattern: build-artifact-*
          merge-multiple: true

      - name: Download changelog
        uses: actions/download-artifact@v4
        with:
          name: changelog

      - name: Create or Update Staging Release
        env:
          GITHUB_TOKEN: ${{ secrets.STG_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          TAG="staging-${{ needs.build.outputs.version }}"
          CHANGELOG=$(cat changelog.txt)
          NOTE="ðŸ§ª Staging build $TAG

          ## ðŸ“ Changes:
          $CHANGELOG"
          echo "ðŸš€ Deploying Staging $TAG"

          if gh release view "$TAG" > /dev/null 2>&1; then
            gh release upload "$TAG" build.zip --clobber
            gh release edit "$TAG" --notes "$NOTE"
          else
            gh release create "$TAG" build.zip --notes "$NOTE"
          fi

  # ===============================
  # ðŸŽ¯ Job 4ï¼šéƒ¨ç½²è‡³ production ç’°å¢ƒï¼ˆéœ€äººå·¥æ‰¹å‡†ï¼‰
  # ===============================
  deploy-production:
    name: Deploy to Production
    needs: [build, deploy-staging]
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: sudo apt install gh -y

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          pattern: build-artifact-*
          merge-multiple: true

      - name: Download changelog
        uses: actions/download-artifact@v4
        with:
          name: changelog

      - name: Create Production Release
        env:
          GITHUB_TOKEN: ${{ secrets.PROD_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          TAG="prod-${{ needs.build.outputs.version }}"
          CHANGELOG=$(cat changelog.txt)
          NOTE="ðŸš€ Official production release $TAG

          ## ðŸ“ Changelog:
          $CHANGELOG

          ## âœ… QA Summary
          - âœ… Passed Lint & Test
          - âœ… Deployed to Dev & Staging
          - âœ… Approved for Production"

          echo "ðŸš€ Creating production release: $TAG"
          if gh release view "$TAG" > /dev/null 2>&1; then
            gh release upload "$TAG" build.zip --clobber
            gh release edit "$TAG" --notes "$NOTE"
          else
            gh release create "$TAG" build.zip --notes "$NOTE"
          fi
