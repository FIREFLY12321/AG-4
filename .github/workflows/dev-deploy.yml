name: CI/CD Deployment Pipeline (Outstanding Level)
permissions:
  contents: write
  pull-requests: write
  issues: write
  pages: write
  id-token: write

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  # ===============================
  # ğŸ—ï¸ Job 1ï¼šå»ºç½® + æ¸¬è©¦ + ä¸Šå‚³ artifact
  # ===============================
  build:
    name: Build and Test (Matrix)
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.NEW_TAG }}
    strategy:
      matrix:
        node: [18, 20]
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node }}

      - name: Install Bun runtime
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Generate Semantic Version
        id: version
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          NEW_TAG=$(echo $LAST_TAG | awk -F. -v OFS=. '{$NF += 1 ; print}')
          echo "NEW_TAG=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ New Version: $NEW_TAG"

      # ğŸ§¾ è‡ªå‹•ç”¢ç”Ÿ changelog
      - name: Generate Changelog
        id: changelog
        if: matrix.node == 18  # åªåœ¨ä¸€å€‹ matrix åŸ·è¡Œ
        run: |
          LAST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")
          if [ -z "$LAST_TAG" ]; then
            CHANGELOG=$(git log --oneline --pretty=format:"- %s (%h)" | head -20)
          else
            CHANGELOG=$(git log ${LAST_TAG}..HEAD --oneline --pretty=format:"- %s (%h)")
          fi
          echo "ğŸ“ Changelog generated"
          echo "CHANGELOG<<EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          echo "$CHANGELOG" > changelog.txt

      # âœ… æ–°å¢ï¼šå°‡ changelog ä½œç‚º artifact å„²å­˜
      - name: Save changelog as artifact
        if: matrix.node == 18
        uses: actions/upload-artifact@v4
        with:
          name: changelog
          path: changelog.txt

      # ğŸ§ª Pre-build lint/test gate (Fail Fast)
      - name: ğŸ” Pre-build Quality Gate
        run: |
          echo "ğŸ” Running quality checks before build..."

          echo "ğŸ“¦ Installing dependencies for checks..."
          bun install
          
          # Lint check (skip if not configured, fail if configured but fails)
          echo "Running lint..."
          set +e
          LINT_OUTPUT=$(bun run lint 2>&1)
          LINT_EXIT=$?
          set -e
          
          if echo "$LINT_OUTPUT" | grep -qi "was not found\|script not found"; then
            echo "âš ï¸ Warning: No lint script configured - skipping"
          elif [ $LINT_EXIT -ne 0 ]; then
            echo "âŒ Lint failed - stopping build"
            echo "$LINT_OUTPUT"
            exit 1
          else
            echo "âœ… Lint passed"
          fi
          
          # Test check (skip if not configured, fail if configured but fails)
          echo "Running tests..."
          set +e
          TEST_OUTPUT=$(bun run test 2>&1)
          TEST_EXIT=$?
          set -e
          
          if echo "$TEST_OUTPUT" | grep -qi "was not found\|script not found"; then
            echo "âš ï¸ Warning: No test script configured - skipping"
          elif [ $TEST_EXIT -ne 0 ]; then
            echo "âŒ Tests failed - stopping build"
            echo "$TEST_OUTPUT"
            exit 1
          else
            echo "âœ… Tests passed"
          fi
          
          echo "âœ… Quality gate passed"

      - name: Build and Package Artifact
        run: |
          echo "ğŸ› ï¸ Building project for Node ${{ matrix.node }}..."
          bun run build
          
          echo "ğŸ§¹ Cleaning previous archives..."
          rm -f build-${{ matrix.node }}.zip
          
          echo "ğŸ—œï¸ Creating distributable archive..."
          zip -r build-${{ matrix.node }}.zip . \
            -x ".git/*" "*.git" "node_modules/*" "build-*.zip" "changelog.txt"
          echo "âœ… Archive ready: build-${{ matrix.node }}.zip"

      - name: Upload build artifact (unique per Node)
        uses: actions/upload-artifact@v4
        with:
          name: build-artifact-${{ matrix.node }}
          path: build-${{ matrix.node }}.zip

      - name: Notify on Deployment Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Production Deployment Failed',
              body: `## Deployment Failure
              
              **Environment:** Production
              **Version:** ${{ needs.build.outputs.version }}
              **Workflow Run:** [View Logs](${context.payload.repository.html_url}/actions/runs/${context.runId})
              
              ### Immediate Action Required
              Production deployment has failed. Please investigate immediately.`,
              labels: ['critical', 'deployment-failure'],
              assignees: ['FIREFLY12321']  // ä½ çš„ GitHub ç”¨æˆ¶å
            })    

  # ===============================
  # ğŸ§ª Job 2ï¼šåŸ·è¡Œå–®å…ƒæ¸¬è©¦
  # ===============================
  test-unit:
    name: Run Unit Tests
    needs: build
    runs-on: ubuntu-latest
    env:
      TEST_ENV: unit
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Bun runtime
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          pattern: build-artifact-*
          merge-multiple: false

      - name: Extract artifact
        run: |
          mkdir -p build
          ZIP_FILE=$(find . -maxdepth 2 -type f -name "build-*.zip" | head -n 1)
          if [ -z "$ZIP_FILE" ]; then
            echo "âŒ æ‰¾ä¸åˆ° build-*.zip artifact"
            ls -R
            exit 1
          fi
          echo "ğŸ“¦ è§£å£“ç¸® artifact: $ZIP_FILE"
          unzip -oq "$ZIP_FILE" -d build

      - name: Install dependencies
        working-directory: build
        run: |
          if [ -d node_modules ]; then
            echo "âœ… node_modules å·²å­˜åœ¨ï¼Œç•¥éå®‰è£"
          else
            bun install
          fi

      - name: Prepare test report directories
        working-directory: build
        run: mkdir -p reports/junit

      - name: Run unit tests
        working-directory: build
        run: |
          set -o pipefail
          bun run test:unit:ci | tee test-results-unit.txt

      - name: Upload unit test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-logs
          path: build/test-results-unit.txt
          if-no-files-found: warn

      - name: Upload unit JUnit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-unit
          path: build/reports/junit/unit-tests.xml
          if-no-files-found: warn
      - name: Notify on Deployment Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Production Deployment Failed',
              body: `## Deployment Failure
              
              **Environment:** Production
              **Version:** ${{ needs.build.outputs.version }}
              **Workflow Run:** [View Logs](${context.payload.repository.html_url}/actions/runs/${context.runId})
              
              ### Immediate Action Required
              Production deployment has failed. Please investigate immediately.`,
              labels: ['critical', 'deployment-failure'],
              assignees: ['FIREFLY12321']  // ä½ çš„ GitHub ç”¨æˆ¶å
            })    

  # ===============================
  # ğŸ§ª Job 3ï¼šåŸ·è¡Œæ•´åˆæ¸¬è©¦èˆ‡è¦†è“‹ç‡
  # ===============================
  test-integration:
    name: Run Integration Tests & Coverage
    needs: test-unit
    runs-on: ubuntu-latest
    env:
      TEST_ENV: integration
      COVERAGE_THRESHOLD: 80
    steps:
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Setup Bun runtime
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          pattern: build-artifact-*
          merge-multiple: false

      - name: Extract artifact
        run: |
          mkdir -p build
          ZIP_FILE=$(find . -maxdepth 2 -type f -name "build-*.zip" | head -n 1)
          if [ -z "$ZIP_FILE" ]; then
            echo "âŒ æ‰¾ä¸åˆ° build-*.zip artifact"
            ls -R
            exit 1
          fi
          echo "ğŸ“¦ è§£å£“ç¸® artifact: $ZIP_FILE"
          unzip -oq "$ZIP_FILE" -d build

      - name: Install dependencies
        working-directory: build
        run: |
          if [ -d node_modules ]; then
            echo "âœ… node_modules å·²å­˜åœ¨ï¼Œç•¥éå®‰è£"
          else
            bun install
          fi

      - name: Prepare test report directories
        working-directory: build
        run: mkdir -p reports/junit

      - name: Run integration tests
        working-directory: build
        run: |
          set -o pipefail
          bun run test:integration:ci | tee test-results-integration.txt

      - name: Run coverage across all tests
        working-directory: build
        run: |
          set -o pipefail
          bun run test:coverage | tee coverage-summary.txt

      - name: Enforce coverage threshold
        working-directory: build
        run: |
          node -e "
            const fs = require('node:fs');
            const summary = fs.readFileSync('coverage-summary.txt', 'utf8');
            const match = summary.match(/# all files\s*\|\s*([\d.]+)/);
            if (!match) {
              console.error('âŒ Unable to locate coverage data');
              process.exit(1);
            }
            const coverage = parseFloat(match[1]);
            const threshold = Number(process.env.COVERAGE_THRESHOLD);
            console.log('ğŸ“Š Line coverage:', coverage + '%');
            if (coverage < threshold) {
              console.error(`âŒ Coverage ${coverage}% is below threshold ${threshold}%`);
              process.exit(1);
            }
          "


      - name: Upload coverage artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: |
            build/coverage-summary.txt
            build/test-results-integration.txt
          if-no-files-found: warn

      - name: Upload integration JUnit report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: junit-integration
          path: build/reports/junit/integration-tests.xml
          if-no-files-found: warn
      - name: Create Issue on Test Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'âŒ Integration Tests Failed',
              body: `## Test Failure Report
              
              **Workflow:** ${context.workflow}
              **Run ID:** ${context.runId}
              **Commit:** ${context.sha}
              
              [View Logs](${context.payload.repository.html_url}/actions/runs/${context.runId})
              
              ### Action Required
              Please review and fix the failing tests before proceeding with deployment.`,
              labels: ['bug', 'ci-failure']
            })
      - name: Generate Coverage Badge
        working-directory: build
        run: |
          # å¾ coverage-summary.txt æå–è¦†è“‹ç‡
          COVERAGE=$(grep "# all files" coverage-summary.txt | awk '{print $4}' | sed 's/%//')
          echo "COVERAGE=$COVERAGE" >> $GITHUB_ENV
          
          # ç”Ÿæˆé¡è‰²
          if (( $(echo "$COVERAGE >= 80" | bc -l) )); then
            COLOR="brightgreen"
          elif (( $(echo "$COVERAGE >= 60" | bc -l) )); then
            COLOR="yellow"
          else
            COLOR="red"
          fi
          echo "COVERAGE_COLOR=$COLOR" >> $GITHUB_ENV

      - name: Comment Coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          script: |
            const coverage = process.env.COVERAGE;
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ğŸ“Š Test Coverage Report
              
              **Coverage:** ${coverage}%
              **Threshold:** 80%
              **Status:** ${coverage >= 80 ? 'âœ… PASSED' : 'âŒ FAILED'}
              
              [View Full Report](${context.payload.repository.html_url}/actions/runs/${context.runId})`
            })
      - name: Comment Coverage on PR
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync('build/coverage-summary.txt', 'utf8');
            const match = summary.match(/# all files\s*\|\s*([\d.]+)/);
            const coverage = match ? match[1] : 'N/A';
            const threshold = 80;
            const status = parseFloat(coverage) >= threshold ? 'âœ… PASSED' : 'âŒ FAILED';
            const color = parseFloat(coverage) >= threshold ? 'ğŸŸ¢' : 'ğŸ”´';
            
            const body = `## ğŸ“Š Test Coverage Report
            
            ${color} **Coverage:** ${coverage}%  
            **Threshold:** ${threshold}%  
            **Status:** ${status}
            
            ### ğŸ“ˆ Coverage Breakdown
            \`\`\`
            ${summary.split('\n').slice(0, 10).join('\n')}
            \`\`\`
            
            [View Full Report](${context.payload.repository.html_url}/actions/runs/${context.runId})
            
            ---
            *Automated coverage report by CI/CD Pipeline*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: body
            });        
      - name: Notify on Deployment Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Production Deployment Failed',
              body: `## Deployment Failure
              
              **Environment:** Production
              **Version:** ${{ needs.build.outputs.version }}
              **Workflow Run:** [View Logs](${context.payload.repository.html_url}/actions/runs/${context.runId})
              
              ### Immediate Action Required
              Production deployment has failed. Please investigate immediately.`,
              labels: ['critical', 'deployment-failure'],
              assignees: ['FIREFLY12321']  // ä½ çš„ GitHub ç”¨æˆ¶å
            })     
      - name: Create Issue on Test Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runUrl = `${context.payload.repository.html_url}/actions/runs/${context.runId}`;
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `âŒ Integration Tests Failed - Run #${context.runNumber}`,
              body: `## ğŸš¨ Test Failure Report
              
              **Workflow:** ${context.workflow}
              **Run Number:** ${context.runNumber}
              **Commit:** \`${context.sha.substring(0, 7)}\`
              **Branch:** ${context.ref}
              **Triggered by:** @${context.actor}
              
              ### ğŸ“‹ Details
              - **Coverage Threshold:** 80%
              - **Test Suite:** Integration Tests
              
              ### ğŸ”— Links
              - [View Workflow Run](${runUrl})
              - [View Commit](${context.payload.repository.html_url}/commit/${context.sha})
              
              ### âš ï¸ Action Required
              Please review the test logs and fix the failing tests before proceeding with deployment.
              
              ---
              *This issue was automatically created by GitHub Actions*`,
              labels: ['bug', 'ci-failure', 'automated']
            });        
            

  # ===============================
  # ğŸ“Š Job 4ï¼šå½™ç¸½æ¸¬è©¦å ±å‘Šï¼ˆJUnit + Allureï¼‰
  # ===============================
  test-reports:
    name: Generate Aggregated Test Reports
    needs: test-integration
    runs-on: ubuntu-latest
    if: ${{ always() }}
    steps:
      - name: æº–å‚™å ±å‘Šç›®éŒ„
        run: mkdir -p reports/junit

      - name: Download JUnit reports
        continue-on-error: true
        uses: actions/download-artifact@v4
        with:
          pattern: junit-*
          path: reports/junit
          merge-multiple: true

      - name: æª¢æŸ¥æ˜¯å¦å­˜åœ¨ JUnit å ±å‘Š
        id: check-junit
        run: |
          if ls reports/junit/*.xml >/dev/null 2>&1; then
            echo "found=true" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸ æœªæ‰¾åˆ° JUnit å ±å‘Šï¼Œç•¥é Allure ç”Ÿæˆ"
            echo "found=false" >> $GITHUB_OUTPUT
          fi

      - name: Install Allure CLI
        if: steps.check-junit.outputs.found == 'true'
        run: |
          sudo apt-get update
          sudo apt-get install -y allure

      - name: Generate Allure report
        if: steps.check-junit.outputs.found == 'true'
        run: |
          mkdir -p reports/allure-results
          cp reports/junit/*.xml reports/allure-results/
          allure generate reports/allure-results --clean -o allure-report

      - name: Upload aggregated JUnit reports
        if: steps.check-junit.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: junit-aggregate
          path: reports/junit/*.xml

      - name: Upload Allure HTML report
        if: steps.check-junit.outputs.found == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: allure-report
          path: allure-report

      - name: Upload Allure report for Pages
        if: github.event_name != 'pull_request' && steps.check-junit.outputs.found == 'true'
        uses: actions/upload-pages-artifact@v3
        with:
          path: allure-report
          artifact-name: allure-pages

  # ===============================
  # ğŸŒ Job 5ï¼šéƒ¨ç½² Allure å ±å‘Šè‡³ GitHub Pages
  # ===============================
  deploy-allure-pages:
    name: Deploy Allure Report to GitHub Pages
    needs: test-reports
    if: github.event_name != 'pull_request'
    runs-on: ubuntu-latest
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Deploy Allure report
        id: deployment
        uses: actions/deploy-pages@v4
        with:
          artifact-name: allure-pages

  # ===============================
  # ğŸš€ Job 6ï¼šéƒ¨ç½²è‡³ dev ç’°å¢ƒ
  # ===============================
  deploy-dev:
    name: Deploy to Development
    needs: [build, test-integration]
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
          
      - name: Install GitHub CLI
        run: sudo apt install gh -y
          
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: build-artifact-*
          merge-multiple: false

      # âœ… æ–°å¢ï¼šä¸‹è¼‰ changelog artifact
      - name: Download changelog
        uses: actions/download-artifact@v4
        with:
          name: changelog
          
      - name: Verify artifact
        run: ls -lh

      - name: Prepare release archive
        run: |
          ZIP_FILE=$(find . -maxdepth 2 -type f -name "build-*.zip" | head -n 1)
          if [ -z "$ZIP_FILE" ]; then
            echo "âŒ æ‰¾ä¸åˆ° build-*.zip artifact"
            ls -R
            exit 1
          fi
          echo "ğŸ“¦ Using artifact: $ZIP_FILE"
          cp "$ZIP_FILE" build.zip
  
      # ğŸ” ä½¿ç”¨ç’°å¢ƒå°ˆå±¬ Secrets
      - name: Create or Update Dev Release
        env:
          GITHUB_TOKEN: ${{ secrets.DEV_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          TAG="dev-${{ needs.build.outputs.version }}"
          CHANGELOG=$(cat changelog.txt)
          NOTE="Development build $TAG
          ## ğŸ“ Changes in this release:
          $CHANGELOG"
          
          echo "ğŸš€ Deploying $TAG"
          if gh release view "$TAG" > /dev/null 2>&1; then
            echo "â™»ï¸ Updating existing dev release..."
            gh release upload "$TAG" build.zip --clobber
            gh release edit "$TAG" --notes "$NOTE"
          else
            echo "ğŸ†• Creating new dev release..."
            gh release create "$TAG" build.zip --notes "$NOTE"
          fi
      - name: Notify on Deployment Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Production Deployment Failed',
              body: `## Deployment Failure
              
              **Environment:** Production
              **Version:** ${{ needs.build.outputs.version }}
              **Workflow Run:** [View Logs](${context.payload.repository.html_url}/actions/runs/${context.runId})
              
              ### Immediate Action Required
              Production deployment has failed. Please investigate immediately.`,
              labels: ['critical', 'deployment-failure'],
              assignees: ['FIREFLY12321']  // ä½ çš„ GitHub ç”¨æˆ¶å
            })      

  # ===============================
  # ğŸ§ª Job 7ï¼šéƒ¨ç½²è‡³ staging ç’°å¢ƒ
  # ===============================
  deploy-staging:
    name: Deploy to Staging
    needs: [build, deploy-dev]
    runs-on: ubuntu-latest
    environment: staging
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
  
      - name: Install GitHub CLI
        run: sudo apt install gh -y
  
      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: build-artifact-*
          merge-multiple: false

      # âœ… æ–°å¢ï¼šä¸‹è¼‰ changelog artifact
      - name: Download changelog
        uses: actions/download-artifact@v4
        with:
          name: changelog

      - name: Prepare release archive
        run: |
          ZIP_FILE=$(find . -maxdepth 2 -type f -name "build-*.zip" | head -n 1)
          if [ -z "$ZIP_FILE" ]; then
            echo "âŒ æ‰¾ä¸åˆ° build-*.zip artifact"
            ls -R
            exit 1
          fi
          echo "ğŸ“¦ Using artifact: $ZIP_FILE"
          cp "$ZIP_FILE" build.zip
  
      - name: Create or Update Staging Release
        env:
          GITHUB_TOKEN: ${{ secrets.STG_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          TAG="staging-${{ needs.build.outputs.version }}"
          CHANGELOG=$(cat changelog.txt)
          NOTE="ğŸ§ª Pre-production test build $TAG
          
          ## ğŸ“ Changes in this release:
          $CHANGELOG"
          
          echo "ğŸš€ Deploying staging release: $TAG"
          if gh release view "$TAG" > /dev/null 2>&1; then
            echo "â™»ï¸ Updating existing staging release..."
            gh release upload "$TAG" build.zip --clobber
            gh release edit "$TAG" --notes "$NOTE"
          else
            echo "ğŸ†• Creating new staging release..."
            gh release create "$TAG" build.zip --notes "$NOTE"
          fi
      - name: Notify on Deployment Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Production Deployment Failed',
              body: `## Deployment Failure
              
              **Environment:** Production
              **Version:** ${{ needs.build.outputs.version }}
              **Workflow Run:** [View Logs](${context.payload.repository.html_url}/actions/runs/${context.runId})
              
              ### Immediate Action Required
              Production deployment has failed. Please investigate immediately.`,
              labels: ['critical', 'deployment-failure'],
              assignees: ['FIREFLY12321']  // ä½ çš„ GitHub ç”¨æˆ¶å
            })          
  # ===============================
  # ğŸ¯ Job 8ï¼šéƒ¨ç½²è‡³ production ç’°å¢ƒï¼ˆéœ€äººå·¥æ‰¹å‡†ï¼‰
  # ===============================
  deploy-production:
    name: Deploy to Production
    needs: [build, deploy-staging]
    runs-on: ubuntu-latest
    environment: production
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install GitHub CLI
        run: sudo apt install gh -y

      - name: Download all build artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: build-artifact-*
          merge-multiple: true

      # âœ… æ–°å¢ï¼šä¸‹è¼‰ changelog artifact
      - name: Download changelog
        uses: actions/download-artifact@v4
        with:
          name: changelog

      - name: Prepare release archive
        run: |
          ZIP_FILE=$(find . -maxdepth 2 -type f -name "build-*.zip" | head -n 1)
          if [ -z "$ZIP_FILE" ]; then
            echo "âŒ æ‰¾ä¸åˆ° build-*.zip artifact"
            ls -R
            exit 1
          fi
          echo "ğŸ“¦ Using artifact: $ZIP_FILE"
          cp "$ZIP_FILE" build.zip

      - name: Create Production Release
        env:
          GITHUB_TOKEN: ${{ secrets.PROD_TOKEN || secrets.GITHUB_TOKEN }}
        run: |
          TAG="prod-${{ needs.build.outputs.version }}"
          CHANGELOG=$(cat changelog.txt)
          NOTE="ğŸš€ Official production release $TAG
          
          ## ğŸ“ Changes in this release:
          $CHANGELOG
          
          ## âœ… Quality Assurance
          - âœ… Passed all tests
          - âœ… Deployed to dev
          - âœ… Deployed to staging
          - âœ… Manual approval granted"
          
          echo "ğŸš€ Creating production release: $TAG"
          if gh release view "$TAG" > /dev/null 2>&1; then
            echo "â™»ï¸ Updating existing production release..."
            gh release upload "$TAG" build.zip --clobber
            gh release edit "$TAG" --notes "$NOTE"
          else
            echo "ğŸ†• Creating new production release..."
            gh release create "$TAG" build.zip --notes "$NOTE"
          fi
      - name: Notify on Deployment Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'ğŸš¨ Production Deployment Failed',
              body: `## Deployment Failure
              
              **Environment:** Production
              **Version:** ${{ needs.build.outputs.version }}
              **Workflow Run:** [View Logs](${context.payload.repository.html_url}/actions/runs/${context.runId})
              
              ### Immediate Action Required
              Production deployment has failed. Please investigate immediately.`,
              labels: ['critical', 'deployment-failure'],
              assignees: ['FIREFLY12321']  // ä½ çš„ GitHub ç”¨æˆ¶å
            })      
      - name: Create Issue on Deployment Failure
        if: failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const runUrl = `${context.payload.repository.html_url}/actions/runs/${context.runId}`;
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `ğŸš¨ Production Deployment Failed - v${{ needs.build.outputs.version }}`,
              body: `## âš ï¸ Critical: Production Deployment Failure
              
              **Version:** v${{ needs.build.outputs.version }}
              **Workflow Run:** [#${context.runNumber}](${runUrl})
              **Commit:** \`${context.sha.substring(0, 7)}\`
              **Deployed by:** @${context.actor}
              
              ### ğŸ” Environment Status
              - âœ… Tests Passed
              - âœ… Dev Deployment: Success
              - âœ… Staging Deployment: Success
              - âŒ Production Deployment: **FAILED**
              
              ### ğŸš¨ Immediate Action Required
              1. Review deployment logs
              2. Check environment configuration
              3. Verify artifact integrity
              4. Rollback if necessary
              
              ### ğŸ”— Quick Links
              - [View Logs](${runUrl})
              - [Release Page](${context.payload.repository.html_url}/releases)
              
              ---
              *This is a critical issue that requires immediate attention*`,
              labels: ['critical', 'deployment-failure', 'production', 'automated'],
              assignees: ['FIREFLY12321']
            });              
